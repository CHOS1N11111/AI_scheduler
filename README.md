# AI 智能排课系统

基于 Streamlit 的交互式排课工具，支持模拟/真实数据导入，提供 Greedy、遗传算法和 OR-Tools CP-SAT 三种求解器，并内置多种可视化与导出能力。

## 功能亮点
- 侧边栏配置教室资源（数量/容量/类型）与算法参数，实时写入会话状态。
- 数据来源双模式：一键生成可控比例的模拟课程数据，或上传 CSV/XLSX 真实课表；支持在线表格编辑、连堂课、专业班级约束和教师禁排。
- 求解器：  
  - GreedySolver：快速但可能次优。  
  - GASolver：带权重的遗传算法。  
  - CPSATSolver：基于 OR-Tools 的精确建模。
- 可视化：最终课表透视视图、高亮冲突/单双周；算法收敛曲线；教室利用率热力图；按教师/教室/行政班级分视图。全部支持 Excel/CSV/PNG 导出。

## 目录结构
- `app.py`：Streamlit 前端与业务流程入口，负责 UI、数据流转和可视化。
- `data_gen.py`：模拟数据生成（课程、教师禁排、连堂概率等可控）。
- `data_adapter.py`：真实数据解析与空模板生成，支持中文时间描述解析。
- `solvers.py`：Greedy、GA、CP-SAT 三种排课算法与约束实现。
- `requirements.txt`：项目依赖。
- `README.md`：项目说明文档。

## 环境与安装
- 建议 Python 3.9+（需支持 `ortools`）。
- 安装依赖：
  ```bash
  pip install -r requirements.txt
  ```

## 运行
```bash
streamlit run app.py
```
浏览器将自动打开 `localhost:8501`。

## 数据格式（上传/下载模板）
使用 `data_adapter.generate_empty_template()` 下载的模板包含以下列（中文表头）：
- `课程名称`、`教师`
- `学生人数限制`（整数）
- `教室类型`：如“非实验室/多媒体”或“实验室/机房”
- `周次`：`每周`/`单周`/`双周`
- `学生专业限制`：逗号分隔的专业/班级列表（留空视为“全校通用”）
- `连课`：1 表示需要连续两节，同一教室、相邻时段
- `教师时间限制`：支持“周三08:00-10:00不可排”或“周三上午不可排/下午不可排/晚上不可排”等描述

标准时间槽：周一至周五，每天 `08:00, 10:00, 14:00, 16:00, 19:00`。解析后形成 `Mon_08:00` 这类键。

## 使用流程
1. **配置资源与算法**：在侧边栏设置教室数量/容量/类型，选择求解器并调整参数（GA 种群/代数/权重，CP-SAT 超时等）。
2. **准备数据**：  
   - “随机模拟”选项卡：设定课程数量、实验课比例、单双周比例后生成。  
   - “导入真实”选项卡：上传 CSV/XLSX，或先下载模板填充后再上传。  
   - 展开“查看/编辑待排课程”可直接在线修改、增删行。
3. **排课**：点击“开始排课”，系统根据选定算法计算并缓存结果。
4. **查看结果**：  
   - 课表视图：按时间×教室透视，高亮冲突/单双周，可导出 Excel。  
   - 分析视图：成功/冲突/未排数量与比率、问题课程列表、GA 收敛曲线。  
   - 交互视图：教室利用率热力图（CSV/PNG 下载），按教师/教室/行政班级切换视图并导出 Excel。

## 求解器约束概览
- 教室类型与容量匹配；同一时间同一教室按周次防冲突。
- 教师冲突与教师禁排时间；行政班级/专业冲突（同一时间同班只上一门课）。
- 连堂课：同一 `link_id` 必须同日相邻时段、同一教室；CP-SAT 允许两门都不排。
- 单/双周复用：odd/even 与 all 资源互斥规则。

## 三种算法简述
- GreedySolver：按课程人数从大到小依次抢占可行的时间与教室，极快但不保证全局最优，适合秒级演示与小规模场景。
- GASolver（遗传算法）：随机初始化方案，通过选择/交叉/变异迭代优化，硬约束冲突代价高、软约束代价低，可借助进度回调观察收敛；在资源受限时比 Greedy 更可能找到更优可行解，但需要更多时间。
- CPSATSolver（OR-Tools CP-SAT）：将排课建模为约束满足/整数规划，支持超时设置；可处理连堂、单双周、教师/专业冲突等复杂约束，并允许未排课程（最大化已排数量、最小化罚项），质量最高但耗时相对最长。
