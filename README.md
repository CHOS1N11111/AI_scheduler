# AI 智能排课系统

基于 Streamlit 的交互式排课工具，支持模拟/真实数据导入，提供 Greedy、遗传算法和 OR-Tools CP-SAT 三种求解器，并内置多种可视化与导出能力。

## 功能亮点
- 侧边栏配置教室资源（数量/容量/类型）与算法参数，实时写入会话状态。
- 数据来源双模式：一键生成可控比例的模拟课程数据，或上传 CSV/XLSX 真实课表；支持在线表格编辑、连堂课、专业班级约束和教师禁排。
- 求解器：  
  - GreedySolver：快速但可能次优。  
  - GASolver：带权重的遗传算法。  
  - CPSATSolver：基于 OR-Tools 的精确建模。
- 可视化：最终课表透视视图、高亮冲突/单双周；算法收敛曲线；教室利用率热力图；按教师/教室/行政班级分视图。全部支持 Excel/CSV/PNG 导出。

## 目录结构
- `app.py`：Streamlit 前端与业务流程入口，负责 UI、数据流转和可视化。
- `data_gen.py`：模拟数据生成（课程、教师禁排、连堂概率等可控）。
- `data_adapter.py`：真实数据解析与空模板生成，支持中文时间描述解析。
- `solvers.py`：Greedy、GA、CP-SAT 三种排课算法与约束实现。
- `requirements.txt`：项目依赖。
- `README.md`：项目说明文档。

## 环境与安装
- 建议 Python 3.9+（需支持 `ortools`）。
- 安装依赖：
  ```bash
  pip install -r requirements.txt
  ```

## 运行
```bash
streamlit run app.py
```
浏览器将自动打开 `localhost:8501`。

## 数据格式（上传/下载模板）
使用 `data_adapter.generate_empty_template()` 下载的模板包含以下列（中文表头）：
- `课程名称`、`教师`
- `学生人数限制`（整数）
- `教室类型`：如“非实验室/多媒体”或“实验室/机房”
- `周次`：`每周`/`单周`/`双周`
- `学生专业限制`：逗号分隔的专业/班级列表（留空视为“全校通用”）
- `连课`：1 表示需要连续两节，同一教室、相邻时段
- `教师时间限制`：支持“周三08:00-10:00不可排”或“周三上午不可排/下午不可排/晚上不可排”等描述

标准时间槽：周一至周五，每天 `08:00, 10:00, 14:00, 16:00, 19:00`。解析后形成 `Mon_08:00` 这类键。

## 使用流程
1. **配置资源与算法**：在侧边栏设置教室数量/容量/类型，选择求解器并调整参数（GA 种群/代数/权重，CP-SAT 超时等）。
2. **准备数据**：  
   - “随机模拟”选项卡：设定课程数量、实验课比例、单双周比例后生成。  
   - “导入真实”选项卡：上传 CSV/XLSX，或先下载模板填充后再上传。  
   - 展开“查看/编辑待排课程”可直接在线修改、增删行。
3. **排课**：点击“开始排课”，系统根据选定算法计算并缓存结果。
4. **查看结果**：  
   - 课表视图：按时间×教室透视，高亮冲突/单双周，可导出 Excel。  
   - 分析视图：成功/冲突/未排数量与比率、问题课程列表、GA 收敛曲线。  
   - 交互视图：教室利用率热力图（支持 CSV/PNG 下载），按教师/教室/行政班级切换视图并导出 Excel。

## 求解器约束概览
- 教室类型与容量匹配；同一时间同一教室按周次防冲突。
- 教师冲突与教师禁排时间；行政班级/专业冲突（同一时间同班只上一门课）。
- 连堂课：同一 `link_id` 必须同日相邻时段、同一教室；CP-SAT 允许两门都不排。
- 单/双周复用：`odd`/`even` 与 `all` 资源互斥规则。

## 三种算法简述
- GreedySolver：基于构造性启发式策略，通过预定义的排序规则（如按课程人数降序）依次为课程分配局部最优的时间与空间资源。（见 `solvers.py` GreedySolver.solve）；由于缺乏全局搜索能力和回溯机制，该算法在处理复杂约束（如教师时间窗或多维度资源竞争）时容易陷入局部最优陷阱。
- GASolver（遗传算法）：属于元启发式随机搜索算法，模拟生物进化过程中的选择、交叉和变异机制，在庞大的解空间中迭代寻找近似最优解。（`solvers.py` GASolver.run）；结合当前数据模型（连堂、单双周、教师禁排、班级冲突），当侧边栏设置的教室总量越高时，GA 找到可行解的概率显著提高，这是因为增加教室数量显著稀释了约束冲突的密度，扩大了可行解的分布范围，从而降低了算法在随机初始化和变异操作中“碰撞”到硬约束（如时间地点冲突）的概率；资源紧时仍有一定韧性，但代价是更长的运行时间。
- CPSATSolver（OR-Tools CP-SAT）：基于约束满足问题 (CSP) 的精确求解引擎，利用布尔可满足性 (SAT) 技术和约束传播机制，旨在寻找满足所有硬约束的数学精确解。（`solvers.py` CPSATSolver.solve）；目标是最大化已排课程并最小化罚项；能表达全部复杂约束，但一旦教室数量低于理论下限或存在逻辑悖论（如单班容量超过教室最大容量），求解器会直接判定为全局无解，而不会像启发式算法那样给出部分排课的次优方案。
